{% extends base.html %}
{% block other_css %}
<link rel="stylesheet" type="text/css" href="/static/plugins/bootstrap-fileupload/bootstrap-fileupload.css" />
<link rel="stylesheet" type="text/css" href="{{ static_url('plugins/cropper/cropper.min.css') }}">
<link rel="stylesheet" type="text/css" href="{{ static_url('css/cropit.css') }}">
<style>
    .mce-container span{
        font-family: Yekan !important;
    }
</style>
{% end block other_css %}
{% block container %}
    <div id="page-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default margin-top-30 font-yekan">
                    <div class="panel-heading"><i class="fa fa-folder-open-o"></i><span>ویرایش و مدیریت اخبار</span> </div>
                    <div class="panel-body">
                        <div class="show_box">
                            <div class="box_header">
                                <span>ویرایش اخبار</span>
                            </div>
                            <div class="box_body unit-div pr_drag">
                                <form id="add_news">
                                    {% module xsrf_form_html() %}
                                    <div class="row">
                                        <div class="col-xs-9">
                                            <div class="row">
                                                <div class="col-xs-3 text-right">
                                                    <span>عنوان:</span>
                                                </div>
                                                <div class="col-xs-9">
                                                    <input name="title" value="{{ news['title'] }}" type="text" class="form-control">
                                                </div>
                                            </div>
                                            <div class="row margin-top-10">
                                                <div class="col-xs-3 text-right">
                                                    <span>خلاصه:</span>
                                                </div>
                                                <div class="col-xs-9">
                                                    <textarea name="summary" type="text" class="form-control">{{ news['summary'] }}</textarea>
                                                </div>
                                            </div>
                                            <div class="row margin-top-10">
                                                <div class="col-xs-3">
                                                    <span class="form_label">عکس</span>
                                                    <input type="hidden" name="image">
                                                </div>
                                                <div class="col-xs-3">
                                                    <div class="row" style="margin: 10px 0">
                                                        <div class="col-md-12 col-sm-12 text-center" style="direction: ltr">
                                                            <div id="news_image_show" class="thumbnail preview-lg" style="overflow: hidden;width: 184px; height: 142px; margin: auto">
                                                                <img class="recipe_photo" src="{{ static_url('images/news_image/' + news['image'] ) }}" alt="" />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-12 col-sm-12 text-center margin-top-20">
                                                            <span data-toggle="modal" href="#news_image_modal" class="R_butt_blue">انتخاب تصویر</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-xs-1 col-xs-offset-2">
                                                    <input name="main_page" value="true" {% if news['main_page'] %}checked{% end %} type="checkbox" class="form-control">
                                                </div>
                                                <div class="col-xs-3 text-right" style="padding: 8px">
                                                    <span>صفحه اصلی</span>
                                                </div>
                                            </div>
                                            <div class="row margin-top-10">
                                                <div class="col-xs-3">
                                                    <span class="form_label">متن</span>
                                                </div>
                                                <div class="col-xs-9">
                                                    <div id="editable" style="font-family: Yekan !important;" class="editable">{% raw news['body'] %}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row margin-top-10">
                                        <div class="col-xs-2 pull-left">
                                            <button type="submit" class="btn R_butt_green add-unit-btn">افزودن</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div class="modal fade in" id="news_image_modal" tabindex="-1" role="basic" aria-hidden="false">
    <div class="modal-dialog" style="font-family: Yekan; width: 50%">
        <div class="modal-content" style="border-radius: 7px !important;">
            <div class="col-md-12 col-sm-12">
                <div class="row" style="background: #b8b8b8;border-radius: 5px 5px 0px 0px !important;padding:10px;">
                    <div class="pull-left">
                        <span style="color: white;font-size: 12pt;margin-top: 2px;display: block">انتخاب تصویر</span>
                    </div>
                    <div class="pull-right">
                        <span class="cursor fa fa-times"
                              style="font-size:15pt;color: white !important;margin-top: 5px;cursor: pointer"
                              data-dismiss="modal" aria-hidden="true"></span>
                    </div>
                </div>
                <div class="row" style="background: #ffffff">
                    <div class="col-md-12 col-sm-12">
                        <div id="news_image" style="direction: ltr">
                            <div class="row margin-top-25">
                                <div class="col-md-8 col-md-offset-2">
                                    <div class="cropit-image-preview-container">
                                        <div class="cropit-image-preview"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="row margin-top-15">
                                <div class="col-md-6 col-md-offset-3">
                                    <div class="row">
                                        <div class="col-md-2 col-sm-2">
                                            <i class="fa fa-picture-o" style="font-size: 24px"></i>
                                        </div>
                                        <div class="col-md-8 col-sm-8">
                                            <input type="range" class="cropit-image-zoom-input" />
                                        </div>
                                        <div class="col-md-2 col-sm-2">
                                            <i class="fa fa-picture-o" style="font-size: 16px"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row margin-top-15 margin-bottom-15">
                                <div class="col-md-4 col-md-offset-4 choose_pic_div">
                                    <input type="file" style="display: none" class="cropit-image-input" />
                                    <div class="R_butt_blue choose_pic text-center">انتخاب تصویر</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" style="border-top: 1px solid #ccc; padding: 15px;background: #b8b8b8">
                    <div class="col-md-6 col-sm-6 text-right pull-right">
                        <span data-dismiss="modal" class="R_butt_green send_image_image">تایید تصویر</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% end block container %}

{% block other_scripts %}
<script type="text/javascript" src="/static/plugins/bootstrap-fileupload/bootstrap-fileupload.js"></script>
<script type="text/javascript" src="{{ static_url('plugins/jquery-ui/jquery-ui.js') }}"></script>
<script type="text/javascript" src="{{ static_url('plugins/tinymce/tinymce.min.js') }}"></script>
<script type="text/javascript" src="{{ static_url('plugins/cropper/jquery.cropit.min.js') }}"></script>
<script>

    var trash = '<i class="fa fa-trash-o"></i>';

    var loader = '<img src="{{ static_url('images/loading.gif') }}" width="20" height="20">';


    $('.choose_pic').click(function(){
         $(this).closest('.choose_pic_div').find('.cropit-image-input').click();
    });

    var news_image = $('#news_image').cropit({
        exportZoom: 1,
        height: 230,
        width: 245,
        imageBackground: true,
        imageBackgroundBorderWidth: 15 // Width of background border
    });

    $('.send_image_image').click(function(){
        var h = news_image.cropit('export');
        $('#news_image_show img').attr({ src: h });
        $('input[name=image]').val(h);
    });
    var __error = false;
    var __message = false;
    function check_value(__val, __msg){
        if((__val == "" || __val == " ") && !__error){
            __error = true;
            __message = __msg;
        }
        return __val
    }

    var __a = true;
    $('#add_news').submit(function(e){
        if(__a){
            __a = false;
            e.preventDefault();
            var btn =$('.add-unit-btn') ;
            btn.html(loader);
            var data = new FormData();
            data.append('_xsrf', '{{ handler.xsrf_token }}');
            data.append('title', check_value($('input[name=title]').val(), 'عنوان را وارد کنید.'));
            data.append('summary', check_value($('textarea[name=summary]').val(), 'خلاصه را وارد کنید.'));
            data.append('body', check_value(tinyMCE.get("editable").getContent(), 'متن را وارد کنید.'));
            data.append('image', $('input[name=image]').val());
            data.append('main_page', $('input[name=main_page]').prop('checked'));
            if(__error){
                Alert.render(__message, function(){
                    btn.html('افزودن');
                    __a = true;
                    __error = false;
                    return;
                });
                __error = false;
                return;
            }
            jQuery.ajax(
                {
                    url: '',
                    type: "post",
                    data: data,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        var status = response['status'];
                        var value = response['value'];
                        var messages = response['messages'];
                        if (status) {
                            Alert.render('success', function () {
                                location.href = "";
                                __a = true;
                            });
                        }else{
                            var error = '';
                            for(var i = 0; i < messages.length ; i++){
                                error += messages[i] + '<br>';
                            }
                            if(error == '')
                                error = 'error';
                            Alert.render(error, function(){
                                btn.html('افزودن');
                                __a = true;
                            });
                        }
                    },
                    error: function () {
                        Alert.render('error', function(){
                            btn.html('افزودن');
                            __a = true;
                        });
                    }
                });
        }
    });

    tinymce.init({
        selector: '.editable',
        height: 250,
        language: "fa",
        plugins: [
            'advlist autolink lists link image charmap print preview anchor directionality',
            'searchreplace visualblocks code fullscreen',
            'insertdatetime media table contextmenu paste code'
        ],
        content_css: '{{ static_url('css/fonts.css') }}',
        toolbar: 'insertfile undo redo | fontselect | fontsizeselect | ltr rtl | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image',
        font_formats: 'Yekan=Yekan',
        fontsize_formats: "8pt 10pt 12pt 14pt 18pt 24pt 36pt"
    });

</script>
{% end block other_scripts %}