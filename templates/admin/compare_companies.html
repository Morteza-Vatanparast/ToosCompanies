{% extends base.html %}
{% block other_css %}
<link rel="stylesheet" type="text/css" href="/static/plugins/bootstrap-fileupload/bootstrap-fileupload.css"/>
<link type="text/css" rel="stylesheet" href="{{ static_url('plugins/jquery-ui/jquery-ui.css') }}">

<style>
    .company-row {
        box-shadow: 0 0 2px #AAA;
        border-radius: 5px;
        padding: 15px;
        background-color: #F8F8F8;
    }
    .company-row:hover {
        background-color: #F0F0F0;
    }
</style>
{% end block other_css %}
{% block container %}
<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default margin-top-30 font-yekan">
                <div class="panel-heading"><i class="fa fa-folder-open-o"></i><span>جستجو شرکت ها</span></div>
                {% if base_company is None and sub_company is None %}
                    <div class="panel-body">
                        <div class="row">
                            <div style="width: 47%" class="col-md-5">
                                <div class="show_box">
                                    <div class="box_header">
                                        <span>جستجو شرکت فرعی</span>
                                    </div>
                                    <div class="box_body unit-div pr_drag">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="loader-sub" style="display: none;position: absolute; top: 7px; left: 20px"><img src="{{ static_url('images/loading.gif') }}" width="20" height="20"></div>
                                                <input type="text" class="form-control" name="search-sub-company">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 sub-company-div" style="padding: 20px">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="width: 6%" class="col-md-2">
                                <i style="font-size: 65px; padding-top: 23px;" class="fa fa-angle-double-left"></i>
                            </div>
                            <div style="width: 47%" class="col-md-5">
                                <div class="show_box">
                                    <div class="box_header">
                                        <span>جستجو شرکت اصلی</span>
                                    </div>
                                    <div class="box_body unit-div pr_drag">
                                        <div class="row">
                                            <div class="col-md-12">
                                                <div class="loader-base" style="display: none;position: absolute; top: 7px; left: 20px"><img src="{{ static_url('images/loading.gif') }}" width="20" height="20"></div>
                                                <input type="text" class="form-control" name="search-base-company">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-12 base-company-div" style="padding: 20px">

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-2 col-md-offset-5 text-center padding-10">
                                <div class="R_butt_green do-compare">مقایسه</div>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="panel-body">
                        <div class="row">
                            <div style="width: 47%" class="col-md-5 sub-company-row">
                                <div class="show_box">
                                    <div class="box_header">
                                        <span>اطلاعات شرکت فرعی</span>
                                    </div>
                                    <div class="box_body unit-div pr_drag">
                                        <div class="row">
                                            <div class="col-xs-12">
                                                <div class="row">
                                                    <div class="col-xs-3 text-right">
                                                        <span>نام:</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input name="name" value="{{ sub_company['name'] }}" type="text" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">آدرس</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <textarea class="form-control" cols="10" rows="5" name="address" style="resize: none">{{ sub_company['address'] }}</textarea>
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">موبایل</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input type="text" name="mobile" value="{{ sub_company['mobile'] }}" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">تلفن</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input type="text" name="phone" value="{{ sub_company['phone'] }}" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">تلفن 2</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input type="text" name="phone2" value="{{ sub_company['phone2'] }}" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">فکس</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input type="text" name="fax" value="{{ sub_company['fax'] }}" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">سایت</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input type="text" name="site" value="{{ sub_company['site'] }}" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">ایمیل</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input type="text" name="email" value="{{ sub_company['email'] }}" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">مدیر عامل</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input type="text" name="ceo" value="{{ sub_company['ceo'] }}" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">مالک</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <input type="text" value="{{ sub_company['owner'] }}" name="owner" class="form-control">
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">استان</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <select class="select" name="province">
                                                            <option value="">انتخاب کنید.</option>
                                                            {% for p in provinces %}
                                                                <option {% if sub_company['province'] == p['_id'] %}selected{% end %} value="{{ p['_id'] }}">{{ p['name'] }}</option>
                                                            {% end %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">شهر</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <select class="select" name="city">
                                                            <option value="">انتخاب کنید.</option>
                                                            {% for c in sub_cities %}
                                                                <option {% if sub_company['city'] == c['_id'] %}selected{% end %} value="{{ c['_id'] }}">{{ c['name'] }}</option>
                                                            {% end %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">واحد</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <select class="select" name="unit">
                                                            <option value="">انتخاب کنید.</option>
                                                            {% for u in units %}
                                                                <option {% if sub_company['unit'] == u['_id'] %}selected{% end %} value="{{ u['_id'] }}">{{ u['name'] }}</option>
                                                            {% end %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">شهرک صنعتی</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <select class="select" name="industrial_town">
                                                            <option value="">انتخاب کنید.</option>
                                                            {% for i in industrial_towns %}
                                                                <option {% if sub_company['industrial_town'] == i['_id'] %}selected{% end %} value="{{ i['_id'] }}">{{ i['name'] }}</option>
                                                            {% end %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row margin-top-10">
                                                    <div class="col-xs-3">
                                                        <span class="form_label">درباره شرکت</span>
                                                    </div>
                                                    <div class="col-xs-9">
                                                        <textarea class="form-control" cols="10" rows="10" name="description" style="resize: none">{{ sub_company['description'] }}</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row text-center padding-10">
                                            <div class="col-md-4 col-md-offset-4">
                                                <div class="R_butt_red delete-company" data-company="{{ sub_company['_id'] }}">حذف</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="width: 6%" class="col-md-2 sub-company-row">
                                <i style="font-size: 65px; padding-top: 430px;" class="fa fa-angle-double-left"></i>
                            </div>
                            <div style="width: 47%" class="col-md-5 base-company-row">
                                <div class="show_box">
                                    <div class="box_header">
                                        <span>اطلاعات شرکت اصلی</span>
                                    </div>
                                    <div class="box_body unit-div pr_drag">
                                        <form id="edit_company">
                                            {% module xsrf_form_html() %}
                                            <input type="hidden" name="company" value="{{ base_company['_id'] }}">
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <div class="row">
                                                        <div class="col-xs-3 text-right">
                                                            <span>نام:</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input name="name" value="{{ base_company['name'] }}" type="text" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">آدرس</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <textarea class="form-control" cols="10" rows="5" name="address" style="resize: none">{{ base_company['address'] }}</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">موبایل</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input type="text" name="mobile" value="{{ base_company['mobile'] }}" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">تلفن</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input type="text" name="phone" value="{{ base_company['phone'] }}" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">تلفن 2</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input type="text" name="phone2" value="{{ base_company['phone2'] }}" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">فکس</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input type="text" name="fax" value="{{ base_company['fax'] }}" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">سایت</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input type="text" name="site" value="{{ base_company['site'] }}" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">ایمیل</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input type="text" name="email" value="{{ base_company['email'] }}" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">مدیر عامل</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input type="text" name="ceo" value="{{ base_company['ceo'] }}" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">مالک</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <input type="text" value="{{ base_company['owner'] }}" name="owner" class="form-control">
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">استان</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <select class="select" name="province">
                                                                <option value="">انتخاب کنید.</option>
                                                                {% for p in provinces %}
                                                                    <option {% if base_company['province'] == p['_id'] %}selected{% end %} value="{{ p['_id'] }}">{{ p['name'] }}</option>
                                                                {% end %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">شهر</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <select class="select" name="city">
                                                                <option value="">انتخاب کنید.</option>
                                                                {% for c in base_cities %}
                                                                    <option {% if base_company['city'] == c['_id'] %}selected{% end %} value="{{ c['_id'] }}">{{ c['name'] }}</option>
                                                                {% end %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">واحد</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <select class="select" name="unit">
                                                                <option value="">انتخاب کنید.</option>
                                                                {% for u in units %}
                                                                    <option {% if base_company['unit'] == u['_id'] %}selected{% end %} value="{{ u['_id'] }}">{{ u['name'] }}</option>
                                                                {% end %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">شهرک صنعتی</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <select class="select" name="industrial_town">
                                                                <option value="">انتخاب کنید.</option>
                                                                {% for i in industrial_towns %}
                                                                    <option {% if base_company['industrial_town'] == i['_id'] %}selected{% end %} value="{{ i['_id'] }}">{{ i['name'] }}</option>
                                                                {% end %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="row margin-top-10">
                                                        <div class="col-xs-3">
                                                            <span class="form_label">درباره شرکت</span>
                                                        </div>
                                                        <div class="col-xs-9">
                                                            <textarea class="form-control" cols="10" rows="10" name="description" style="resize: none">{{ base_company['description'] }}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row text-center padding-10">
                                                <div class="col-md-4 col-md-offset-4">
                                                    <button class="R_butt_green edit-company-btn">اعمال تغییرات</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% end %}
            </div>
        </div>
    </div>
</div>

{% end block container %}

{% block other_scripts %}
<script type="text/javascript" src="{{ static_url('plugins/bootstrap-fileupload/bootstrap-fileupload.js') }}"></script>
<script type="text/javascript" src="{{ static_url('plugins/jquery-ui/jquery-ui.js') }}"></script>
<script>

    var trash = '<i class="fa fa-trash-o"></i>';

    var loader = '<img src="{{ static_url('images/loading.gif') }}" width="15" height="15">';

    var __static_url = '{{ static_url('images/company_logo/' + '__pic__') }}';
    $(document).on('keyup','input[name=search-base-company]',function(){
        if($(this).val() != ''){
            $('.loader-base').show();
            var arr = {
                text: $(this).val(),
                _xsrf: '{{ handler.xsrf_token }}'
            };
            var th = $(this);
            $.ajax({
                data: arr,
                type: 'put',
                url: '',
                async: true,
                success: function(output){
                    var ret = JSON.parse(output);
                    if (ret.status == 'ok'){
                        $(th).autocomplete({
                            source: ret.full_item
                        }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
                            return $( "<li>" )
                                    .append('<a>' +
                                            '<img src="' + __static_url.replace('__pic__', item.pic) + '" height="50" width="50" class="img-circle img-thumbnail autocomp_item_img">' +
                                            '<span style="vertical-align: middle;font-size:10pt; !important;">' + item.label + '</span>' +
                                        '</a>')
                                    .appendTo(ul);
                        };
                        $('.loader-base').hide();

                    }
                },
                complete: function(){
                    $('.loader-base').hide();
                },
                fail: function(){
                    $('.loader-base').hide();
                }
            });
        }
    });


    $(document).on('keyup','input[name=search-sub-company]',function(){
        if($(this).val() != ''){
            $('.loader-sub').show();
            var arr = {
                text: $(this).val(),
                _xsrf: '{{ handler.xsrf_token }}'
            };
            var th = $(this);
            $.ajax({
                data: arr,
                type: 'put',
                url: '',
                async: true,
                success: function(output){
                    var ret = JSON.parse(output);
                    if (ret.status == 'ok'){
                        $(th).autocomplete({
                            source: ret.full_item
                        }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
                            return $( "<li>" )
                                    .append('<a>' +
                                            '<img src="' + __static_url.replace('__pic__', item.pic) + '" height="50" width="50" class="img-circle img-thumbnail autocomp_item_img">' +
                                            '<span style="vertical-align: middle;font-size:10pt; !important;">' + item.label + '</span>' +
                                        '</a>')
                                    .appendTo(ul);
                        };
                        $('.loader-sub').hide();

                    }
                },
                complete: function(){
                    $('.loader-sub').hide();
                },
                fail: function(){
                    $('.loader-sub').hide();
                }
            });
        }
    });

    var company_base = null;
    var company_sub = null;

    $('input[name=search-base-company]').autocomplete({
        select: function( a, b ) {
            company_base = b.item.id;
            var html = '<div class="col-md-12 product-row" style="margin-top: 10px">\
                        <div class="company-row">\
                            <div class="row">\
                                <div class="col-md-4 col-sm-4">\
                                    <img src="' + __static_url.replace("__pic__", b.item.pic) + '"\ class="img-circle" style="height: 50px; width: 50px">\
                                </div>\
                                <div class="col-md-8 col-sm-8">\
                                    <span>' + b.item.label + '</span><br>\
                                </div>\
                            </div>\
                        </div>\
                    </div>';
            $(".base-company-div").html(html);
        }
    });

    $('input[name=search-sub-company]').autocomplete({
        select: function( a, b ) {
            company_sub = b.item.id;
            var html = '<div class="col-md-12 product-row" style="margin-top: 10px">\
                        <div class="company-row">\
                            <div class="row">\
                                <div class="col-md-4 col-sm-4">\
                                    <img src="' + __static_url.replace("__pic__", b.item.pic) + '"\ class="img-circle" style="height: 50px; width: 50px">\
                                </div>\
                                <div class="col-md-8 col-sm-8">\
                                    <span>' + b.item.label + '</span><br>\
                                </div>\
                            </div>\
                        </div>\
                    </div>';
            $(".sub-company-div").html(html);
        }
    });

    $(document).on('click', '.do-compare', function(){
        if(company_base == null || company_sub == null){
            Alert.render('شرکت ها را انتخاب کنید.', function(){});
            return;
        }
        if(company_base == company_sub){
            Alert.render('شرکت های یکسان انتخاب کرده اید.', function(){});
            return;
        }
        location.href = "{{ reverse_url('admin:compare_companies_by_id', '__base__', '__sub__') }}".replace('__base__', company_base).replace('__sub__', company_sub);
    });


    var __b = true;
    $(document).on('click', '.delete-company', function(e){
        if(__b){
            __b = false;
            Confirm.render(0, 0, 0, 0, 0, function(){
                var elm = $(e.target).closest('.delete-company');
                var company = elm.attr('data-company');
                elm.html(loader);
                var postData = [
                    {name: 'company', value: company},
                    {name: '_xsrf', value: '{{ handler.xsrf_token }}'},
                    {name: 'action', value: 'delete'}
                ];
                jQuery.ajax(
                    {
                        url: '{{ reverse_url('admin:companies') }}',
                        type: "delete",
                        data: postData,
                        success: function (response) {
                            var status = response['status'];
                            var value = response['value'];
                            var messages = response['messages'];
                            if (status) {
                                Alert.render('success', function () {
                                    $('.sub-company-row').remove();
                                    $('.base-company-row').css('width', '100%');
                                    __b = true;
                                });
                            }else{
                                var error = '';
                                for(var i = 0; i < messages.length ; i++){
                                    error += messages[i] + '<br>';
                                }
                                if(error == '')
                                    error = 'error';
                                Alert.render(error, function(){
                                    __b = true;
                                });
                            }
                        },
                        error: function () {
                            Alert.render('error', function(){
                                __b = true;
                            });
                        }
                    });
            }, function(){
                __b = true;
            });
        }
    });

    var __a = true;
    $('#edit_company').submit(function(e){
        if(__a){
            var btn =$('.edit-company-btn') ;
            btn.html(loader);
            __a = false;
            e.preventDefault();
            var postData = $("#edit_company").serializeArray();
            jQuery.ajax(
                {
                    url: '',
                    type: "post",
                    data: postData,
                    success: function (response) {
                        var status = response['status'];
                        var value = response['value'];
                        var messages = response['messages'];
                        if (status) {
                            Alert.render('success', function () {
                                location.href = "{{ reverse_url('admin:compare_companies') }}";
                                __a = true;
                            });
                        }else{
                            var error = '';
                            for(var i = 0; i < messages.length ; i++){
                                error += messages[i] + '<br>';
                            }
                            if(error == '')
                                error = 'error';
                            Alert.render(error, function(){
                                btn.html('اعمال تغییرات');
                                __a = true;
                            });
                        }
                    },
                    error: function () {
                        Alert.render('error', function(){
                            btn.html('اعمال تغییرات');
                            __a = true;
                        });
                    }
                });
        }
    });

</script>
{% end block other_scripts %}